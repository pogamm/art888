<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Weekly Comparison</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: sans-serif;
    background: #f4f6fb;
    margin: 0;
    padding: 16px;
  }

  .card {
    background: #fff;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,.08);
  }

  h2 {
    text-align: center;
    margin-bottom: 8px;
  }

  .compare {
    margin-top: 12px;
    font-size: 14px;
    text-align: center;
  }

  .good { color: #16a34a; }
  .bad { color: #dc2626; }
  .neutral { color: #6b7280; }

  canvas {
    width: 100% !important;
    height: 240px !important;
  }
</style>
</head>

<body>

<div class="card">
  <h2>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
  <canvas id="chart"></canvas>
  <div id="compareText" class="compare"></div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const rawHistory = params.get("history");

// ‡πÅ‡∏õ‡∏•‡∏á historyScores
let history = [];
try {
  history = rawHistory ? JSON.parse(rawHistory) : [];
} catch {
  history = [];
}

// ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô (‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
if (history.length > 7) {
  history = history.slice(-7);
}

// labels ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á
const labels = history.map((_, i) => `Day ${i + 1}`);

// ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
const ctx = document.getElementById("chart").getContext("2d");
new Chart(ctx, {
  type: "line",
  data: {
    labels,
    datasets: [{
      label: "Total Score",
      data: history,
      borderColor: "#2563eb",
      backgroundColor: "rgba(37,99,235,.2)",
      tension: 0.4,
      fill: true,
      pointRadius: 5,
      pointBackgroundColor: "#1e40af"
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: { y: { beginAtZero: true } }
  }
});

// üîÅ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
const compareText = document.getElementById("compareText");

if (history.length < 2) {
  compareText.innerHTML =
    `<span class="neutral">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</span>`;
} else {
  const today = history[history.length - 1];
  const yesterday = history[history.length - 2];
  const diff = today - yesterday;

  if (diff > 0) {
    compareText.innerHTML =
      `<span class="good">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô +${diff} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô üìà</span>`;
  } else if (diff < 0) {
    compareText.innerHTML =
      `<span class="bad">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏î‡∏•‡∏á ${Math.abs(diff)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô üìâ</span>`;
  } else {
    compareText.innerHTML =
      `<span class="neutral">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‚öñÔ∏è</span>`;
  }
}
</script>

</body>
</html>
